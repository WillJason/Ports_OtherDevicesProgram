C51 COMPILER V9.01   MAIN                                                                  07/16/2014 12:05:51 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\output\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE src\main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\output\main.lst) OBJECT(.\outp
                    -ut\main.obj)

line level    source

   1          /*********************************************************************************************************
             -*********
   2                  
   3                                                                  +--------------------------------------------------+
   4                                                                                   主函数部分
   5                                                                  +--------------------------------------------------+
   6          
   7           - 实现功能：
   8          
   9           - 目前进展：
  10           - 日期    ：2013-05-06
  11          
  12           - 作者    ：
  13          
  14           - 运行环境：STC   晶振：11.0592M     波特率:9600
  15          
  16           - 备注    ：在普中科技的51开发板上调试OK --- STC89C516RD+
  17           
  18           1、实现芯片上电分别指定播放第一曲和第二曲，基本的程序供用户测试
  19           2、该测试程序必须是模块或者芯片方案中，有设备在线，譬如U盘、TF卡、FLASH等等
  20           3、
  21          **********************************************************************************************************
             -********/
  22          #include "STK6037.h"
  23          
  24          //运行晶振：11.05926MHZ
  25          #define TIMER0_H   (65536-1800)/256//定时2Ms
  26          #define TIMER0_L   (65536-1800)%256
  27          
  28          #define SYS_Fosc        11059200  //晶振频率                       
  29          #define COMM_BAUD_RATE  9600      //串口波特率
  30          
  31          #define OSC_FREQ        11059200  //11059200  
  32          
  33          
  34          static INT8U Send_buf[10] = {0} ;
  35          static INT8U Recv_buf[10] = {0} ;
  36          
  37          static INT8U SendDataLen = 0 ;
  38          static INT8U ResendDataLen = 0 ;
  39          
  40          /******************************串口1的波特率********************************/
  41          //T1作波特率发生器
  42          //在波特率加倍情况下 
  43          #define BAUD_57600                      256 - (OSC_FREQ/192L)/57600L    // 254 FF
  44          #define BAUD_28800                      256 - (OSC_FREQ/192L)/28800L    // 254 FE
  45          #define BAUD_19200                      256 - (OSC_FREQ/192L)/19200L    // 253 FD
  46          #define BAUD_14400                      256 - (OSC_FREQ/192L)/14400L    // 252 FC
  47          #define BAUD_9600                       256 - (OSC_FREQ/192L)/9600L     // 250 FA
  48          
  49          /*****************************************************************************************************
  50           - 功能描述：10us的延时函数
  51           - 隶属模块：常用函数库(内部)
  52           - 参数说明：无
C51 COMPILER V9.01   MAIN                                                                  07/16/2014 12:05:51 PAGE 2   

  53           - 返回参数：无
  54           - 注： 在这里的运行环境是51,晶振为12MHZ                
  55          *****************************************************************************************************/
  56          void Delay_Us(INT32U z)
  57          {
  58   1              while(z--);
  59   1      }
  60          
  61          /***********************毫秒级别延时************************/
  62          
  63          void Delay_Ms(INT32U z)
  64          {
  65   1              INT32U x=0 , y=0;
  66   1              for(x=110 ; x>0 ;x--)
  67   1              for(y=z; y>0;y-- );
  68   1      }
  69          
  70          /*****************************************************************************************************
  71           - 功能描述： 串口1初始化
  72           - 隶属模块： 外部
  73           - 参数说明： 无
  74           - 返回说明： 无
  75           - 注：       都是9600波特率
  76          *****************************************************************************************************/
  77          void Serial_init(void)
  78          {
  79   1              TMOD = 0x20;                // 设置 T1 为波特率发生器
  80   1              SCON = 0x50;                // 0101,0000 8位数据位, 无奇偶校验
  81   1                                                      
  82   1              PCON = 0x00;                //PCON=0;
  83   1      
  84   1              TH1=256-(SYS_Fosc/COMM_BAUD_RATE/32/12);//设置为9600波特率
  85   1              TL1=256-(SYS_Fosc/COMM_BAUD_RATE/32/12);
  86   1      
  87   1          TR1     = 1;                           //定时器1打开
  88   1          REN     = 1;                           //串口1接收使能
  89   1          ES      = 1;                           //串口1中断使能
  90   1      }
  91          
  92          
  93          /********************************************************************************************
  94           - 功能描述： 串口发送一个字节
  95           - 隶属模块： 外部
  96           - 参数说明：
  97           - 返回说明：
  98           - 注：       
  99          ********************************************************************************************/
 100          void Uart_PutByte(INT8U ch)
 101          {
 102   1          SBUF  = ch;
 103   1          while(!TI){;}
 104   1          TI = 0;
 105   1      }
 106          
 107          /*****************************************************************************************************
 108           - 功能描述： 串口发送一帧数据
 109           - 隶属模块： 内部 
 110           - 参数说明： 
 111           - 返回说明： 
 112           - 注：无     
 113          *****************************************************************************************************/
 114          void SendCmd(INT8U len)
C51 COMPILER V9.01   MAIN                                                                  07/16/2014 12:05:51 PAGE 3   

 115          {
 116   1          INT8U i = 0 ;
 117   1      
 118   1          Uart_PutByte(0x7E); //起始
 119   1          for(i=0; i<len; i++)//数据
 120   1          {
 121   2                      Uart_PutByte(Send_buf[i]) ;
 122   2          }
 123   1          Uart_PutByte(0xEF) ;//结束
 124   1      }
 125          
 126          /********************************************************************************************
 127           - 功能描述：求和校验
 128           - 隶属模块：
 129           - 参数说明：
 130           - 返回说明：
 131           - 注：      和校验的思路如下
 132                       发送的指令，去掉起始和结束。将中间的6个字节进行累加，最后取反码
 133                       接收端就将接收到的一帧数据，去掉起始和结束。将中间的数据累加，再加上接收到的校验
 134                       字节。刚好为0.这样就代表接收到的数据完全正确。
 135          ********************************************************************************************/
 136          void DoSum( INT8U *Str, INT8U len)
 137          {
 138   1          INT16U xorsum = 0;
 139   1          INT8U i;
 140   1      
 141   1          for(i=0; i<len; i++)
 142   1          {
 143   2              xorsum  = xorsum + Str[i];
 144   2          }
 145   1              xorsum     = 0 -xorsum;
 146   1              *(Str+i)   = (INT8U)(xorsum >>8);
 147   1              *(Str+i+1) = (INT8U)(xorsum & 0x00ff);
 148   1      }
 149          
 150          
 151          /********************************************************************************************
 152           - 功能描述： 串口向外发送命令[包括控制和查询]
 153           - 隶属模块： 外部
 154           - 参数说明： CMD:表示控制指令，请查阅指令表，还包括查询的相关指令
 155                        feedback:是否需要应答[0:不需要应答，1:需要应答]
 156                        data:传送的参数
 157           - 返回说明：
 158           - 注：       
 159          ********************************************************************************************/
 160          void Uart_SendCMD(INT8U CMD ,INT8U feedback , INT16U dat)
 161          {
 162   1          Send_buf[0] = 0xff;    //保留字节 
 163   1          Send_buf[1] = 0x06;    //长度
 164   1          Send_buf[2] = CMD;     //控制指令
 165   1          Send_buf[3] = feedback;//是否需要反馈
 166   1          Send_buf[4] = (INT8U)(dat >> 8);//datah
 167   1          Send_buf[5] = (INT8U)(dat);     //datal
 168   1          DoSum(&Send_buf[0],6);        //校验
 169   1          SendCmd(8);       //发送此帧数据
 170   1      }
 171          
 172          void main()
 173          { 
 174   1              Delay_Us(1) ;
 175   1              Delay_Ms(1) ;
 176   1      
C51 COMPILER V9.01   MAIN                                                                  07/16/2014 12:05:51 PAGE 4   

 177   1              Serial_init() ;
 178   1      
 179   1          Delay_Ms(1000) ;//延时大概6S
 180   1          
 181   1          Uart_SendCMD(0x03 , 0 , 0x01) ;//播放第一首
 182   1          
 183   1          Delay_Ms(1000) ;//延时大概6S
 184   1          
 185   1          Uart_SendCMD(0x03 , 0 , 0x02) ;//播放第二首
 186   1      
 187   1          Delay_Ms(1000) ;//延时大概6S
 188   1      
 189   1          Uart_SendCMD(0x03 , 0 , 0x04) ;//播放第四首
 190   1      
 191   1          while(1) ;
 192   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    395    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     22      21
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
